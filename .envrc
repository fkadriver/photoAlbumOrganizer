# Use flake for development environment
use flake

# Only reload when these files change
watch_file flake.nix
watch_file flake.lock
watch_file requirements.txt

# Prompt to run photo organizer on directory entry
_photo_organizer_prompt() {
  # Check viewer status
  local viewer_status=""
  if [ -f .viewer.pid ]; then
    local vpid vport
    vpid=$(head -1 .viewer.pid 2>/dev/null || true)
    vport=$(sed -n '2p' .viewer.pid 2>/dev/null || true)
    if [ -n "$vpid" ] && kill -0 "$vpid" 2>/dev/null; then
      viewer_status=" (running on port ${vport})"
    fi
  fi

  echo ""
  echo "=========================================="
  echo "  Photo Album Organizer"
  echo "=========================================="
  if [ -f .photo_organizer_settings.json ]; then
    echo "  Saved settings found."
    echo ""
    echo "  [r] Run with saved settings"
    echo "  [i] Interactive setup"
    echo "  [v] Web viewer${viewer_status}"
    echo "  [s] Drop to shell"
    echo "=========================================="
    printf "  Your choice [s]: "
    read -r choice
    case "$choice" in
      r|R)
        echo "  Running with saved settings..."
        ./photo_organizer.py -r
        ;;
      i|I)
        ./photo_organizer.py -i
        ;;
      v|V)
        scripts/viewer start
        ;;
      *)
        echo "  Dropping to shell. Run './photo_organizer.py -i' to start."
        ;;
    esac
  else
    echo ""
    echo "  [i] Interactive setup"
    echo "  [v] Web viewer${viewer_status}"
    echo "  [s] Drop to shell"
    echo "=========================================="
    printf "  Your choice [s]: "
    read -r choice
    case "$choice" in
      i|I)
        ./photo_organizer.py -i
        ;;
      v|V)
        scripts/viewer start
        ;;
      *)
        echo "  Dropping to shell. Run './photo_organizer.py -i' to start."
        ;;
    esac
  fi
}
_photo_organizer_prompt
